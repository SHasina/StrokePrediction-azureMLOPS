name: Test
on:
  push:
    branches:
      - prod
  workflow_dispatch:
    inputs:
      enableManualDeployment:
        required: true
        description: allowed manual deployment
        default: execute
env:
  CONTAINER_APP_ENVIRONMENT: mlstudio
  STORAGE_CONTAINER_NAME: mlstudio
  STORAGE_ACCOUNT_NAME: mlstudio1
  CONTAINER_APP_NAME: mlstudio
  RESOURCE_GROUP: mlstudio
  REGION: eastus

jobs:
  job1:
    name: Run test
    runs-on: ubuntu-20.04
    steps:
      - id: step1
        name: checkout
        uses: actions/checkout@v2
      - id: step2
        name: download and setup python version
        uses: actions/setup-python@v3
        with:
          python-version: 3.10.0
          cache: pip
      - id: step3
        name: Install packages
        shell: bash
        run: |
          pip install -r requirements.txt
      - id: step4
        name: build and test model
        shell: bash
        run: |
          pytest -v -s
  job2:
    name: Build and save model as artifact
    runs-on: ubuntu-20.04
    needs: [job1]
    steps:
      - id: step1
        name: checkout
        uses: actions/checkout@v2
      - id: step2
        name: download and setup python version
        uses: actions/setup-python@v3
        with:
          python-version: 3.10.0
          cache: pip
      - id: step3
        name: Install packages
        shell: bash
        run: |
          pip install -r requirements.txt
      - id: step4
        name: Build model
        shell: bash
        run: |
          python3 build.py
      - id: step5
        name: Upload model as artifact
        uses: actions/upload-artifact@v3
        with:
          name: model
          path: model.pkl
          retention-days: 1
  job3:
    name: upload model to storage account
    runs-on: ubuntu-latest
    needs: [job2]
    steps:

      - id: step1
        name: checkout
        uses: actions/checkout@v3
      
      - id: step2
        name: 'Az CLI login'
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENANT_ID }}
          subscription-id: ${{ secrets.SUBSCRIPTION_ID }}
  

      - id: step3
        name: create storage bucket
        continue-on-error: true
        shell: bash
        run: |
          az storage account create -n $STORAGE_ACCOUNT_NAME -g $RESOURCE_GROUP --kind StorageV2 -l $REGION  -t Account

      - id: step4
        name: create storage container
        continue-on-error: true
        shell: bash
        run: |
          az storage container create -n $STORAGE_CONTAINER_NAME --account-name $STORAGE_ACCOUNT_NAME
          OUTPUT=$(az storage account show-connection-string --name $STORAGE_ACCOUNT_NAME --resource-group $RESOURCE_GROUP --query "connectionString" -o tsv | tr -d '[:space:]')
          echo "::set-output name=OUTPUT::$OUTPUT"
      # - id: step5
      #   name: download artifacts
      #   uses: actions/download-artifact@v3
      #   with:
      #     name: model
      - id: step6
        name: display connection string
        shell: bash
        run: |
          echo steps.step4.outputs.OUTPUT